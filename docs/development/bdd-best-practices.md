# 用 Context7 寫 BDD 最佳實踐

本文以 Context7 風格組織（明確目標、可操作規範、反模式、量測、工具、範例、檢核表），協助團隊在 .NET/API 專案中穩定落地 BDD，強化需求對齊、測試可讀性與交付品質。

## 目標（Why）
- 將需求語意轉為可執行規格：以 Gherkin 描述行為，以步驟碼連接系統。
- 讓測試成為可讀的產品文件：Stakeholders 能看懂、工程師能維護、CI 能執行。
- 降低回歸成本：透過穩定、快速、明確失敗訊息的自動化。

## 原則（Principles）
- 以行為為中心：從「使用者/消費者行為」與「可見輸出」切入，而非內部實作。
- 情境驅動：Given（前置條件）— When（動作）— Then（可觀察結果）。
- 可讀可談：避免技術細節淹沒商業語意；讓 PM/QA 能參與評審。
- 穩定獨立：案例彼此獨立、資料可控、重跑可預期。
- 快速回饋：區分層級（單元/整合/端對端），以最快的可驗證層覆蓋大多數行為。

## 規範（Conventions）
### 規格撰寫（Gherkin）
- 命名：`Feature: <領域/能力>`，`Scenario: <使用者價值> - <關鍵條件>`。
- 結構：盡量使用 `Scenario Outline` + `Examples` 帶入多組資料，取代重複情境。
- 語意：每個步驟只做一件事；Then 僅檢查可觀察行為，不檢查實作細節。
- 可追溯：在描述中標註需求/票號，如【JIRA-123】。

### 步驟碼（Step Definitions）
- 映射清晰：一個步驟對應一個意圖；參數型步驟優先，避免爆量相似步驟。
- 共享組件：資料工廠（Test Data Builder）、API/DB 客戶端、環境設定集中管理。
- 穩定資料：優先使用測試容器或隔離資料庫 Schema；避免依賴共享狀態。
- 可觀察性：失敗訊息包含關鍵輸入/輸出、追蹤 Id、相依外部呼叫摘要。

### 測試分層（Testing Pyramid）
- 單元測試：覆蓋規則/轉換/邏輯，快速、純記憶體、無 I/O。
- 合約/整合測試：對外部邊界（DB/Queue/HTTP）做最小充分覆蓋；可用 Testcontainers。
- 端對端（少量）：僅涵蓋跨服務關鍵旅程與高風險路徑，確保用戶視角可用性。

## 反模式（Anti-patterns）
- 過度 UI 驅動：所有情境都走端對端，導致脆弱與緩慢。
- 內部耦合：步驟碼讀取私有欄位或依賴非公開副作用。
- 資料污染：測試互相依賴資料或不清理，造成隨機失敗（flaky）。
- 巨型情境：一個 Scenario 驗證多個彼此獨立規則，失敗定位困難。
- Then 做動作：在 Then 中修改狀態或呼叫外部服務。

## 量測（Metrics）
- 規格覆蓋：關鍵業務流程是否皆有 Scenario/Outline 覆蓋。
- 執行穩定度：flaky 率（重跑失敗/總失敗），目標 < 2%。
- 回饋時間：CI BDD 階段執行時間可控（依專案大小目標 5–10 分鐘）。
- 可讀性：每月評審 1–2 次，Stakeholders 能閱讀並給出改進建議。

## 工具（Tooling）
- .NET 生態：可採用 SpecFlow、BDDfy 或輕量 Gherkin Parser + 自訂 Step 綁定。
- 測試容器：Testcontainers（SQL Server/Postgres/Message broker）確保環境一致性。
- 記錄/追蹤：將 `traceId`/`correlationId` 納入輸出，測試失敗時輸出診斷字串。
- CI 整合：
  - 平行化：以容器/工作分片切分 Feature 集合。
  - 成果產出：輸出 JUnit/HTML 報告，作為可讀交付物。

## 範例（API 情境模板）
Feature: 職缺查詢
  為了讓求職者能快速找到職缺
  做為使用者
  我想要依條件查詢並得到分頁結果

  Scenario Outline: 依關鍵字與地區查詢成功 - <關鍵字>/<地區>
    Given 已存在以下職缺資料
      | jobId | title           | region |
      | 1001  | 資料工程師       | TPE    |
      | 1002  | 後端工程師       | TNN    |
    When 呼叫查詢 API，條件為 <關鍵字> 與 <地區>，頁碼 1，每頁 10 筆
    Then 回應狀態碼為 200
    And 回應結果包含職缺標題含 <關鍵字> 且地區為 <地區>
    And 回應包含分頁資訊（頁碼=1、頁大小=10）

    Examples:
      | 關鍵字     | 地區 |
      | 工程師     | TPE |
      | 工程師     | TNN |

實作要點：
- `Given` 使用資料工廠在測試資料庫建置職缺；或透過 API 种子端點建立後再清理。
- `When` 抽象為 `JobApiClient.SearchAsync()`；將查詢條件物件化以重用。
- `Then` 驗證輸出 JSON 的可見欄位與分頁中繼資料，不檢查內部 ORM 細節。

## 檢核表（Checklist）
- [ ] Feature/Scenario 名稱以使用者價值命名，含需求追蹤碼。
- [ ] 每個 Scenario 可重跑、獨立、不共享狀態。
- [ ] Given/When/Then 單一責任、語意清晰、無內部耦合。
- [ ] 測試資料以工廠/容器隔離，測後清理。
- [ ] 報告與失敗訊息可讀，含關鍵輸入/輸出與追蹤 Id。
- [ ] CI 內可並行、時間受控、flaky 率受監控。

## FAQ（常見問題）
**Q: 既有系統龐大，如何漸進導入？**
先從一條關鍵用戶旅程建立端對端情境，並回流抽象至下層整合/單元測試，逐步替換高成本 UI 測試。

**Q: 外部依賴造成不穩定怎麼辦？**
以 Testcontainers 啟動依賴服務或以 Mock Server/錄製回放替代；必要時為外部依賴建立「合約測試」。

**Q: 規格如何維持與需求同步？**
將 Feature 當成版本化產物，納入需求變更評審流程；以 PR 模版要求更新對應 Scenario。

---
建議將本文件納入定期技術規範評審，並配合 CI 報表與 flaky 監控持續改善。
