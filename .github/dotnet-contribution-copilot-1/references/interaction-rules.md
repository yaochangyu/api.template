# AI 助理互動規則

> 本文件定義 AI 助理與使用者互動時必須遵循的核心原則

## 核心互動原則

### 1. 強制互動確認

**規則**：在所有需要使用者決策的情境下，都必須明確詢問，不得擅自執行

**實作方式**：
- GitHub Copilot: 使用結構化的文字列表詢問（1️⃣, 2️⃣, 3️⃣ 或 a, b, c）
- Claude CLI: 使用 `AskUserQuestion` 工具進行結構化詢問
- Cursor / 其他 AI: 使用結構化的文字列表詢問

**範例**：
```markdown
請選擇 API 開發流程：

1️⃣ API First（推薦）
   - 先定義 OpenAPI 規格 (doc/openapi.yml)
   - 透過 task codegen-api-server 產生 Controller 骨架
   - 確保 API 契約優先、文件與實作同步

2️⃣ Code First
   - 直接實作程式碼
   - 後續手動維護 OpenAPI 規格或透過程式碼註解產生文件

請輸入 1 或 2：
```

### 2. 不得擅自假設

**規則**：即使文件標註「預設」值，仍須詢問使用者確認

**例外情況**：
- 使用者已在對話中明確指定（如「使用 SQL Server」）
- 使用者明確表示「使用預設值」

**範例**：
```markdown
❌ 錯誤做法：
「我將使用 SQL Server 2022 作為資料庫...」（未詢問）

✅ 正確做法：
「請選擇資料庫類型：
 1️⃣ SQL Server 2022（預設）
 2️⃣ PostgreSQL
 3️⃣ MySQL
請輸入選項：」
```

### 3. 分階段互動

**規則**：單次詢問最多 3-4 個問題，避免資訊過載

**實作策略**：
- 將複雜流程拆分成多個階段
- 根據前一階段的回答決定後續問題
- 每個階段專注於相關的決策

**範例**：
```markdown
✅ 階段 1：基礎配置
1. 資料庫類型？
2. 是否使用 Redis？
3. 專案結構組織方式？

等待使用者回答...

✅ 階段 2：資料庫詳細配置（根據階段 1 選擇）
如果選擇 SQL Server：
1. SQL Server 版本？
2. 是否使用 EF Core？
3. Code First 或 Database First？

❌ 錯誤做法：一次問 10 個問題
```

### 4. 完整性優先

**規則**：必須收集所有必要資訊後才開始執行

**檢查清單**：
- [ ] 所有必要的配置資訊已收集
- [ ] 使用者已確認所有選擇
- [ ] 沒有模糊或未定義的參數

**範例**：
```markdown
✅ 正確流程：
收集資訊 → 確認 → 執行

❌ 錯誤流程：
部分資訊 → 執行 → 發現缺少資訊 → 再問 → 執行
```

## 強制詢問情境

### 1. 專案初始化與配置

必須詢問的項目：
- [ ] 資料庫類型選擇
- [ ] Redis 快取需求
- [ ] 專案結構組織方式（單一專案 vs 多專案）
- [ ] 是否使用 GitHub 範本（https://github.com/yaochangyu/api.template）

### 2. 資料庫相關操作

必須詢問的項目：
- [ ] Code First vs Database First 模式選擇
- [ ] Migration 名稱（由使用者提供）
- [ ] 資料表範圍選擇（反向工程時）

### 3. 功能實作

必須詢問的項目（依序）：

**a) API 開發流程選擇**
- API First（推薦）
- Code First

**b) OpenAPI 規格定義狀態**（僅當選擇 API First）
- 已定義
- 需要更新
- 尚未定義

**c) 需要實作的分層**
- Controller
- Handler
- Repository

**d) 測試需求與範圍**（詳見測試策略）

### 4. 測試策略

必須詢問的項目（依序）：

**階段 1：測試需求**
```markdown
是否需要實作測試？
1️⃣ 完整測試（BDD 整合測試 + 單元測試）
2️⃣ 僅 BDD 整合測試
3️⃣ 僅單元測試
4️⃣ 暫不實作測試（快速原型、POC 驗證）
```

**階段 2：測試範圍**（如果需要測試）
```markdown
測試範圍為何？
a) 新增功能的完整測試
b) 僅測試核心業務邏輯
c) 僅測試關鍵路徑（Happy Path）
d) 包含異常情境與邊界條件
```

**階段 3：BDD 測試情境**（如果選擇 BDD 測試）
```markdown
BDD 測試設定：
1. 是否已有 .feature 檔案？
2. 需要新增哪些情境（Given-When-Then）？
3. 是否需要 AI 協助撰寫 Gherkin 語法？
```

**階段 4：測試資料準備**
```markdown
測試資料準備策略：
a) 使用 Docker 容器（資料庫、Redis）
b) 使用固定測試資料（Seed Data）
c) 每次測試動態產生資料
d) 測試後是否需要清理資料？
```

**核心規則**：
- ✅ API 端點測試必須使用 BDD 測試方法
- ✅ 優先使用 Testcontainers（Docker 容器）作為測試替身
- ✅ 僅在無法使用 Testcontainers 時才考慮使用 Mock
- ✅ 禁止對 Controller 進行單元測試

### 5. 效能最佳化

必須詢問的項目：
- [ ] 優化面向選擇（資料庫查詢/快取策略/非同步處理/記憶體使用）

## 禁止的行為 ❌

### 1. 擅自使用預設值
```markdown
❌ 錯誤：「我將使用預設的 SQL Server 2022...」
✅ 正確：「請選擇資料庫類型：1) SQL Server 2022（預設）...」
```

### 2. 跳過詢問步驟
```markdown
❌ 錯誤：直接開始實作 Controller
✅ 正確：先詢問 API 開發流程、測試策略
```

### 3. 一次詢問過多問題
```markdown
❌ 錯誤：一次問 10 個問題
✅ 正確：分 3 階段，每階段 3-4 個問題
```

### 4. 提供不明確的選項
```markdown
❌ 錯誤：「選擇資料庫：1) SQL Server 2) 其他」
✅ 正確：「選擇資料庫：
         1) SQL Server 2022 - 企業級關聯式資料庫
         2) PostgreSQL 14 - 開源關聯式資料庫
         3) MySQL 8 - 常用於 Web 應用程式」
```

### 5. 假設測試需求
```markdown
❌ 錯誤：「我將實作 BDD 測試...」（未詢問）
✅ 正確：「是否需要實作測試？1) 完整測試 2) 僅 BDD...」
```

### 6. 跳過測試實作詢問
```markdown
❌ 錯誤：實作新功能時沒有詢問測試策略
✅ 正確：每個新功能都必須詢問測試策略
```

## 互動流程範例

### 完整互動範例：實作會員註冊功能

```markdown
🤖 AI：收到您要實作「會員註冊功能」的需求。讓我先了解開發方式：

階段 1：開發流程選擇
請選擇 API 開發流程：
1️⃣ API First（推薦）- 先定義 OpenAPI 規格，再產生程式碼
2️⃣ Code First - 直接實作程式碼

請輸入 1 或 2：

👤 使用者：1

🤖 AI：了解，將使用 API First 流程。

階段 2：OpenAPI 規格狀態
請問 doc/openapi.yml 中關於會員註冊 API 的規格：
1️⃣ 已定義完整規格
2️⃣ 需要更新/新增規格
3️⃣ 尚未定義

請輸入選項：

👤 使用者：3

🤖 AI：了解，需要從頭定義 OpenAPI 規格。

階段 3：測試策略
是否需要實作測試？
1️⃣ 完整測試（BDD 整合測試 + 單元測試）
2️⃣ 僅 BDD 整合測試
3️⃣ 僅單元測試
4️⃣ 暫不實作測試

請輸入選項：

👤 使用者：2

🤖 AI：了解，將實作 BDD 整合測試。

階段 4：BDD 測試情境
請確認需要的測試情境：
a) 成功註冊新會員
b) 重複 Email 註冊失敗
c) 無效 Email 格式驗證
d) 必填欄位驗證

請輸入需要的情境（例如：a,b,c,d 或 a,b）：

👤 使用者：a,b,c,d

🤖 AI：完美！我已收集完所有必要資訊。

📋 執行計劃：
1. 定義 OpenAPI 規格（會員註冊 API）
2. 產生 Server Controller 骨架
3. 撰寫 BDD 測試情境（4 個情境）
4. 實作 Handler 業務邏輯
5. 實作 Repository 資料存取
6. 實作 BDD 測試步驟
7. 執行測試驗證

開始執行？(y/n)

👤 使用者：y

🤖 AI：開始執行...
```

## 總結

**核心精神**：
1. **尊重使用者決策權** - 不擅自假設
2. **清晰溝通** - 提供明確選項與說明
3. **循序漸進** - 分階段收集資訊
4. **完整性保證** - 收集完整資訊再執行

**適用對象**：
- GitHub Copilot CLI
- Claude CLI  
- Cursor
- 其他 AI 助理工具

---

**參考來源**：CLAUDE.md - AI 助理使用規則章節
