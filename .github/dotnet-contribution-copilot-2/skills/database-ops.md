# Skill: database-ops (è³‡æ–™åº«æ“ä½œ)

## ğŸ“‹ è·è²¬
EF Core Migration ç®¡ç†ã€è³‡æ–™åº«åå‘å·¥ç¨‹ã€è³‡æ–™åº«æ›´æ–°æ“ä½œ

## ğŸ¯ ä½¿ç”¨æ™‚æ©Ÿ
- éœ€è¦å»ºç«‹æ–°çš„ Migration
- éœ€è¦å¾ç¾æœ‰è³‡æ–™åº«ç”¢ç”Ÿ Entity é¡åˆ¥
- éœ€è¦æ›´æ–°è³‡æ–™åº«çµæ§‹
- éœ€è¦æª¢è¦–æˆ–å›æ»¾ Migration

## ğŸ“ å·¥ä½œæµç¨‹

### 1. è©¢å•æ“ä½œé¡å‹
```
1ï¸âƒ£ è³‡æ–™åº«æ“ä½œé¡å‹ï¼š
   - å»ºç«‹ Migration
   - å¥—ç”¨ Migration è‡³è³‡æ–™åº«
   - å¾è³‡æ–™åº«åå‘å·¥ç¨‹ç”¢ç”Ÿ Entity
   - æª¢è¦– Migration æ¸…å–®
   - ç”¢ç”Ÿ Migration SQL è…³æœ¬
   - å›æ»¾ Migration
   - ç§»é™¤æœªå¥—ç”¨çš„ Migration
```

### 2. æ ¹æ“šæ“ä½œé¡å‹åŸ·è¡Œå°æ‡‰æµç¨‹

## ğŸ”¨ æ“ä½œé¡å‹è©³è§£

### A. å»ºç«‹ Migration

#### è©¢å•
```
1ï¸âƒ£ Migration åç¨± (PascalCase)ï¼š
   ç¯„ä¾‹: CreateMemberTable, AddEmailUniqueIndex
   
2ï¸âƒ£ è®Šæ›´æè¿°ï¼š
   ç°¡çŸ­æè¿°æ­¤ Migration åšäº†ä»€éº¼è®Šæ›´
```

#### åŸ·è¡Œ
```bash
task ef-migration-add NAME=CreateMemberTable
```

#### è¼¸å‡ºèªªæ˜
```
âœ… Migration æª”æ¡ˆä½ç½®:
   - Migrations/{Timestamp}_CreateMemberTable.cs
   - Migrations/{Timestamp}_CreateMemberTable.Designer.cs
   - Migrations/JobBankDbContextModelSnapshot.cs

âš ï¸ æ³¨æ„ï¼š
   - æª¢è¦–ç”¢ç”Ÿçš„ Migration æª”æ¡ˆç¢ºèªè®Šæ›´æ­£ç¢º
   - ç¢ºèªå¾Œå†åŸ·è¡Œ task ef-database-update
```

---

### B. å¥—ç”¨ Migration

#### è©¢å•
```
1ï¸âƒ£ å¥—ç”¨ç¯„åœï¼š
   - å¥—ç”¨æ‰€æœ‰æœªåŸ·è¡Œçš„ Migration
   - å¥—ç”¨è‡³ç‰¹å®š Migration
   - å›æ»¾è‡³ç‰¹å®š Migration
   
2ï¸âƒ£ æ˜¯å¦éœ€è¦å…ˆæª¢è¦– SQL è…³æœ¬ï¼Ÿ
   - âœ… æ˜¯ (æ¨è–¦ï¼Œå…ˆæª¢è¦–å†åŸ·è¡Œ)
   - âŒ å¦ (ç›´æ¥åŸ·è¡Œ)
```

#### åŸ·è¡Œ
```bash
# æª¢è¦– SQL è…³æœ¬ï¼ˆä¸å¯¦éš›åŸ·è¡Œï¼‰
task ef-migration-script

# å¥—ç”¨æ‰€æœ‰æœªåŸ·è¡Œçš„ Migration
task ef-database-update

# å¥—ç”¨è‡³ç‰¹å®š Migration
task ef-database-update TARGET=CreateMemberTable

# å›æ»¾è‡³ç‰¹å®š Migration
task ef-database-update TARGET=InitialCreate
```

---

### C. åå‘å·¥ç¨‹ (Database First)

#### è©¢å•
```
1ï¸âƒ£ åå‘å·¥ç¨‹ç¯„åœï¼š
   - å®Œæ•´è³‡æ–™åº«ï¼ˆæ‰€æœ‰è³‡æ–™è¡¨ï¼‰
   - éƒ¨åˆ†è³‡æ–™è¡¨ï¼ˆæŒ‡å®šè¡¨åï¼‰
   
2ï¸âƒ£ å¦‚é¸æ“‡éƒ¨åˆ†è³‡æ–™è¡¨ï¼Œè«‹è¼¸å…¥è¡¨åï¼š
   ç¯„ä¾‹: Members, Orders, OrderItems
   
âš ï¸ è­¦å‘Šï¼š
   æ­¤æ“ä½œæœƒè¦†è“‹ AutoGenerated è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
   æ˜¯å¦ç¹¼çºŒï¼Ÿ
   - âœ… æ˜¯
   - âŒ å¦
```

#### åŸ·è¡Œ
```bash
# å®Œæ•´è³‡æ–™åº«åå‘å·¥ç¨‹
task ef-codegen

# éƒ¨åˆ†è³‡æ–™è¡¨ï¼ˆéœ€ä¿®æ”¹ Taskfile.ymlï¼‰
# åŠ å…¥ --table Members --table Orders åƒæ•¸
```

#### è¼¸å‡ºèªªæ˜
```
âœ… ç”¢ç”Ÿçš„æª”æ¡ˆä½ç½®:
   src/be/JobBank1111.Job.DB/AutoGenerated/
   â”œâ”€â”€ Member.cs
   â”œâ”€â”€ Order.cs
   â”œâ”€â”€ OrderItem.cs
   â””â”€â”€ JobBankDbContext.cs

âš ï¸ é‡è¦ï¼š
   - é€™äº›æª”æ¡ˆä¸å¯æ‰‹å‹•ç·¨è¼¯
   - å¦‚éœ€æ“´å±•ï¼Œä½¿ç”¨ partial class åœ¨å…¶ä»–æª”æ¡ˆ
```

---

### D. æª¢è¦– Migration

#### åŸ·è¡Œ
```bash
task ef-migration-list
```

#### è¼¸å‡ºç¯„ä¾‹
```
Migration History:
âœ… 20250101120000_InitialCreate (Applied)
âœ… 20250102130000_AddMemberTable (Applied)
â³ 20250103140000_AddEmailIndex (Pending)
```

---

### E. ç”¢ç”Ÿ SQL è…³æœ¬

#### è©¢å•
```
1ï¸âƒ£ è…³æœ¬ç¯„åœï¼š
   - æ‰€æœ‰æœªå¥—ç”¨çš„ Migration
   - å¾ç‰¹å®š Migration è‡³æœ€æ–°
   - å…©å€‹ç‰¹å®š Migration ä¹‹é–“
   
2ï¸âƒ£ è¼¸å‡ºä½ç½®ï¼š
   - è¼¸å‡ºè‡³æ§åˆ¶å°
   - å„²å­˜è‡³æª”æ¡ˆ (æŒ‡å®šè·¯å¾‘)
```

#### åŸ·è¡Œ
```bash
# è¼¸å‡ºè‡³æ§åˆ¶å°
task ef-migration-script

# å„²å­˜è‡³æª”æ¡ˆ
task ef-migration-script > migrations.sql
```

---

### F. ç§»é™¤ Migration

#### è­¦å‘Šè©¢å•
```
âš ï¸ è­¦å‘Šï¼š
   æ­¤æ“ä½œå°‡ç§»é™¤æœ€å¾Œä¸€å€‹æœªå¥—ç”¨çš„ Migration
   
   Migration åç¨±: {MigrationName}
   å»ºç«‹æ™‚é–“: {CreateTime}
   
   æ˜¯å¦ç¢ºèªç§»é™¤ï¼Ÿ
   - âœ… æ˜¯
   - âŒ å¦
   
âš ï¸ æ³¨æ„ï¼š
   åªèƒ½ç§»é™¤å°šæœªå¥—ç”¨è‡³è³‡æ–™åº«çš„ Migration
   å¦‚å·²å¥—ç”¨ï¼Œéœ€å…ˆå›æ»¾
```

#### åŸ·è¡Œ
```bash
task ef-migration-remove
```

## ğŸ¯ Code First vs Database First

### è©¢å•é–‹ç™¼æ¨¡å¼ï¼ˆé¦–æ¬¡ä½¿ç”¨æ™‚ï¼‰
```
1ï¸âƒ£ è³‡æ–™åº«é–‹ç™¼æ¨¡å¼ï¼š
   - Code First (Migration æ¨¡å¼)
     â†’ é©åˆï¼šæ–°å°ˆæ¡ˆã€é–‹ç™¼åœ˜éšŠæ§åˆ¶è³‡æ–™åº«
     â†’ å„ªé»ï¼šç‰ˆæœ¬æ§åˆ¶ã€è‡ªå‹•åŒ–éƒ¨ç½²
     
   - Database First (åå‘å·¥ç¨‹æ¨¡å¼)
     â†’ é©åˆï¼šç¾æœ‰è³‡æ–™åº«ã€DBA ç®¡ç†
     â†’ å„ªé»ï¼šèˆ‡ DBA æµç¨‹æ•´åˆ
```

### Code First å·¥ä½œæµç¨‹
```
1. å®šç¾©/ä¿®æ”¹ Entity é¡åˆ¥
2. task ef-migration-add NAME=<MigrationName>
3. æª¢è¦– Migration æª”æ¡ˆ
4. task ef-database-update
```

### Database First å·¥ä½œæµç¨‹
```
1. DBA åœ¨è³‡æ–™åº«å»ºç«‹/ä¿®æ”¹è³‡æ–™è¡¨
2. task ef-codegen
3. è‡ªå‹•ç”¢ç”Ÿ Entity è‡³ AutoGenerated è³‡æ–™å¤¾
4. ä½¿ç”¨ partial class æ“´å±•åŠŸèƒ½
```

## ğŸš¨ é‡è¦è­¦å‘Š

### âŒ ç¦æ­¢ç›´æ¥åŸ·è¡Œ dotnet ef æŒ‡ä»¤
```bash
# âŒ éŒ¯èª¤
dotnet ef migrations add CreateTable
dotnet ef database update

# âœ… æ­£ç¢º
task ef-migration-add NAME=CreateTable
task ef-database-update
```

**åŸå› **ï¼š
- çµ±ä¸€ç®¡ç†å°ˆæ¡ˆè·¯å¾‘èˆ‡åƒæ•¸
- é¿å…åœ¨éŒ¯èª¤çš„å°ˆæ¡ˆä¸­åŸ·è¡Œ
- ç¢ºä¿é€£ç·šå­—ä¸²æ­£ç¢º

### âš ï¸ Migration å‘½åè¦ç¯„
```
âœ… å¥½çš„å‘½å:
- CreateMemberTable
- AddEmailUniqueConstraint
- RemoveObsoleteColumns
- UpdateMemberIndexes

âŒ é¿å…çš„å‘½å:
- Migration1
- Update
- Fix
- Test
```

### âš ï¸ AutoGenerated è³‡æ–™å¤¾è¦å‰‡
```
src/be/JobBank1111.Job.DB/AutoGenerated/
â”œâ”€â”€ âš ï¸ ä¸å¯æ‰‹å‹•ç·¨è¼¯
â”œâ”€â”€ âš ï¸ é‡æ–°åŸ·è¡Œ ef-codegen æœƒè¦†è“‹
â””â”€â”€ âœ… ä½¿ç”¨ partial class åœ¨å…¶ä»–æª”æ¡ˆæ“´å±•
```

## âœ… æˆåŠŸæ¢ä»¶
- [x] Migration æª”æ¡ˆç”¢ç”ŸæˆåŠŸ
- [x] è³‡æ–™åº«æ›´æ–°æˆåŠŸ
- [x] åå‘å·¥ç¨‹ç”¢ç”Ÿçš„æª”æ¡ˆä½ç½®æ­£ç¢º
- [x] æ‰€æœ‰æ“ä½œéƒ½é€é Taskfile åŸ·è¡Œ

## ğŸ“š åƒè€ƒæ–‡ä»¶
- EF Core æœ€ä½³å¯¦è¸: [@references/ef-core-best-practices.md](../references/ef-core-best-practices.md)

## ğŸ’¡ ä½¿ç”¨ç¯„ä¾‹

```bash
# ä½¿ç”¨æ­¤ skill
@database-ops å»ºç«‹æ–°çš„ Migration: AddMemberTable

# AI è©¢å•ç¯„ä¾‹
> 1ï¸âƒ£ ç¢ºèª Migration åç¨±ï¼šAddMemberTable
> 2ï¸âƒ£ è®Šæ›´æè¿°ï¼šå»ºç«‹æœƒå“¡è³‡æ–™è¡¨ï¼ŒåŒ…å«åŸºæœ¬æ¬„ä½èˆ‡ç´¢å¼•
> 3ï¸âƒ£ åŸ·è¡ŒæŒ‡ä»¤ï¼štask ef-migration-add NAME=AddMemberTable
> 
> âœ… Migration å·²å»ºç«‹ï¼Œæª”æ¡ˆä½ç½®ï¼š
>    Migrations/20250103140000_AddMemberTable.cs
> 
> ä¸‹ä¸€æ­¥ï¼š
> 1. æª¢è¦– Migration æª”æ¡ˆç¢ºèªè®Šæ›´
> 2. åŸ·è¡Œ task ef-database-update å¥—ç”¨è‡³è³‡æ–™åº«
```

## ğŸ”§ Taskfile æŒ‡ä»¤åƒè€ƒ

```bash
# Migration ç›¸é—œ
task ef-migration-add NAME=<MigrationName>  # å»ºç«‹ Migration
task ef-migration-list                      # åˆ—å‡ºæ‰€æœ‰ Migration  
task ef-migration-remove                    # ç§»é™¤æœ€å¾Œä¸€å€‹ Migration
task ef-migration-script                    # ç”¢ç”Ÿ SQL è…³æœ¬

# è³‡æ–™åº«æ›´æ–°
task ef-database-update                     # å¥—ç”¨æ‰€æœ‰ Migration
task ef-database-update TARGET=<Migration>  # å¥—ç”¨è‡³ç‰¹å®š Migration

# åå‘å·¥ç¨‹
task ef-codegen                             # å¾è³‡æ–™åº«ç”¢ç”Ÿ Entity

# DbContext ç›¸é—œ
task ef-dbcontext-info                      # é¡¯ç¤º DbContext è³‡è¨Š
task ef-dbcontext-list                      # åˆ—å‡ºæ‰€æœ‰ DbContext
```

## ğŸ”— ç›¸é—œ Skills
- `api-dev` - API é–‹ç™¼ï¼ˆéœ€è¦ Entityï¼‰
- `code-review` - æª¢æŸ¥ Migration å“è³ª

## ğŸ”— ç›¸é—œ Agents
- `feature-dev-agent` - åŠŸèƒ½é–‹ç™¼ï¼ˆå¯èƒ½éœ€è¦ Migrationï¼‰
