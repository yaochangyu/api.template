# OpenAPI 程式碼產生工作流程

## 概述

本專案採用 **API First** 開發方式，先定義 OpenAPI 規格，再透過工具產生伺服器控制器與客戶端程式碼，確保 API 契約、文件與實作的一致性。

## 工作流程

```
編輯 OpenAPI 規格 (doc/openapi.yml)
    ↓
產生伺服器控制器 (NSwag)
    ↓
產生客戶端程式碼 (Refitter)
    ↓
實作業務邏輯 (Handler + Repository)
    ↓
執行 BDD 測試驗證
```

## 工具鏈

| 工具 | 用途 | 產生位置 |
|------|------|----------|
| **NSwag** | 產生 ASP.NET Core Controller 骨架 | `{Project}.WebAPI/Contract/AutoGenerated/` |
| **Refitter** | 產生強型別 API 客戶端 (Refit) | `{Project}.Contract/AutoGenerated/` |
| **Swagger UI** | 互動式 API 文件 | `/swagger` |
| **ReDoc** | 美化版 API 文件 | `/api-docs` |
| **Scalar** | 現代化 API 文件檢視器 | `/scalar` |

## OpenAPI 規格範例

### 基本結構 (doc/openapi.yml)

```yaml
openapi: 3.0.1
info:
  title: JobBank API
  description: 求職平台 API 服務
  version: 1.0.0
  contact:
    name: API Support
    email: support@jobbank.com

servers:
  - url: https://api.jobbank.com
    description: Production
  - url: https://staging-api.jobbank.com
    description: Staging
  - url: http://localhost:5000
    description: Development

tags:
  - name: Members
    description: 會員管理相關 API
  - name: Jobs
    description: 職缺管理相關 API

paths:
  /api/members:
    post:
      tags:
        - Members
      summary: 註冊新會員
      operationId: CreateMember
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMemberRequest'
      responses:
        '201':
          description: 會員建立成功
          headers:
            Location:
              description: 新會員資源的 URI
              schema:
                type: string
                example: /api/members/m12345
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberResponse'
        '400':
          description: 輸入驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email 已被使用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/members/{id}:
    get:
      tags:
        - Members
      summary: 取得會員資訊
      operationId: GetMember
      parameters:
        - name: id
          in: path
          required: true
          description: 會員 ID
          schema:
            type: string
            example: m12345
      responses:
        '200':
          description: 成功取得會員資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemberResponse'
        '404':
          description: 會員不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CreateMemberRequest:
      type: object
      required:
        - email
        - name
        - password
      properties:
        email:
          type: string
          format: email
          description: 電子郵件
          example: test@example.com
        name:
          type: string
          minLength: 2
          maxLength: 50
          description: 姓名
          example: 張三
        password:
          type: string
          format: password
          minLength: 8
          description: 密碼（至少 8 個字元）
          example: SecurePass@123

    MemberResponse:
      type: object
      properties:
        id:
          type: string
          description: 會員 ID
          example: m12345
        email:
          type: string
          format: email
          example: test@example.com
        name:
          type: string
          example: 張三
        createdAt:
          type: string
          format: date-time
          example: "2025-01-01T12:00:00Z"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: 錯誤訊息
          example: Email 已被使用
        code:
          type: string
          description: 錯誤代碼
          example: DUPLICATE_EMAIL
        traceId:
          type: string
          description: 追蹤 ID
          example: 0HN7Q3J2K3L4M5N6

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []
```

## 程式碼產生指令

### 1. 產生伺服器控制器（NSwag）

```bash
# 使用 Taskfile
task codegen-api-server

# 直接執行（不推薦）
dotnet nswag run nswag.json
```

**nswag.json 設定**：
```json
{
  "runtime": "Net80",
  "documentGenerator": {
    "fromDocument": {
      "url": "doc/openapi.yml"
    }
  },
  "codeGenerators": {
    "openApiToTypeScriptClient": false,
    "openApiToCSharpController": {
      "className": "{controller}Controller",
      "namespace": "JobBank1111.Job.WebAPI.Contract.AutoGenerated",
      "output": "src/be/JobBank1111.Job.WebAPI/Contract/AutoGenerated/Controllers.g.cs",
      "controllerStyle": "Abstract",
      "useCancellationToken": true,
      "generateModelValidationAttributes": true,
      "routeNamingStrategy": "OperationId"
    }
  }
}
```

**產生的控制器範例**：
```csharp
// src/be/{Project}.WebAPI/Contract/AutoGenerated/Controllers.g.cs

namespace JobBank1111.Job.WebAPI.Contract.AutoGenerated;

[ApiController]
public abstract class MembersControllerBase : ControllerBase
{
    /// <summary>
    /// 註冊新會員
    /// </summary>
    [HttpPost("api/members")]
    [ProducesResponseType(typeof(MemberResponse), StatusCodes.Status201Created)]
    [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status400BadRequest)]
    [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status409Conflict)]
    public abstract Task<IActionResult> CreateMember(
        [FromBody] CreateMemberRequest request,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// 取得會員資訊
    /// </summary>
    [HttpGet("api/members/{id}")]
    [ProducesResponseType(typeof(MemberResponse), StatusCodes.Status200OK)]
    [ProducesResponseType(typeof(ErrorResponse), StatusCodes.Status404NotFound)]
    public abstract Task<IActionResult> GetMember(
        string id,
        CancellationToken cancellationToken = default);
}
```

### 2. 實作控制器

```csharp
// src/be/{Project}.WebAPI/Member/MemberController.cs

namespace JobBank1111.Job.WebAPI.Member;

/// <summary>
/// 會員管理 API 實作
/// </summary>
public sealed class MemberController : MembersControllerBase
{
    private readonly MemberHandler _handler;
    
    public MemberController(MemberHandler handler)
    {
        _handler = handler;
    }
    
    public override async Task<IActionResult> CreateMember(
        CreateMemberRequest request,
        CancellationToken cancellationToken = default)
    {
        var result = await _handler.CreateMemberAsync(request, cancellationToken);
        
        if (!result.IsSuccess)
        {
            return result.Error switch
            {
                "DUPLICATE_EMAIL" => Conflict(new ErrorResponse 
                { 
                    Error = result.Error, 
                    Code = "DUPLICATE_EMAIL" 
                }),
                _ => BadRequest(new ErrorResponse { Error = result.Error })
            };
        }
        
        return CreatedAtAction(
            nameof(GetMember),
            new { id = result.Value.Id },
            result.Value);
    }
    
    public override async Task<IActionResult> GetMember(
        string id,
        CancellationToken cancellationToken = default)
    {
        var result = await _handler.GetMemberAsync(id, cancellationToken);
        
        return result.IsSuccess
            ? Ok(result.Value)
            : NotFound(new ErrorResponse { Error = result.Error, Code = "NOT_FOUND" });
    }
}
```

### 3. 產生客戶端程式碼（Refitter）

```bash
# 使用 Taskfile
task codegen-api-client

# 直接執行（不推薦）
refitter doc/openapi.yml --output src/be/JobBank1111.Job.Contract/AutoGenerated/IJobBankApi.g.cs
```

**refitter.settings 設定**：
```json
{
  "openApiPath": "doc/openapi.yml",
  "namespace": "JobBank1111.Job.Contract.AutoGenerated",
  "naming": {
    "useOpenApiTitle": false,
    "interfaceName": "IJobBankApi"
  },
  "generateContracts": true,
  "typeAccessibility": "Public",
  "useCancellationTokens": true,
  "returnIApiResponse": false,
  "generateXmlDocCodeComments": true
}
```

**產生的客戶端範例**：
```csharp
// src/be/{Project}.Contract/AutoGenerated/IJobBankApi.g.cs

namespace JobBank1111.Job.Contract.AutoGenerated;

/// <summary>
/// JobBank API Client
/// </summary>
[Headers("User-Agent: JobBank-Client")]
public interface IJobBankApi
{
    /// <summary>
    /// 註冊新會員
    /// </summary>
    [Post("/api/members")]
    Task<MemberResponse> CreateMemberAsync(
        [Body] CreateMemberRequest request,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// 取得會員資訊
    /// </summary>
    [Get("/api/members/{id}")]
    Task<MemberResponse> GetMemberAsync(
        string id,
        CancellationToken cancellationToken = default);
}

// 註冊客戶端
services.AddRefitClient<IJobBankApi>()
    .ConfigureHttpClient(c => c.BaseAddress = new Uri("https://api.jobbank.com"));
```

## 開發流程範例

### 情境：新增「會員登入」功能

#### 1. 編輯 OpenAPI 規格

```yaml
# doc/openapi.yml

paths:
  /api/members/login:
    post:
      tags:
        - Members
      summary: 會員登入
      operationId: LoginMember
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: 登入成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: 帳號或密碼錯誤

components:
  schemas:
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT Token
        expiresAt:
          type: string
          format: date-time
```

#### 2. 產生程式碼

```bash
# 產生伺服器控制器
task codegen-api-server

# 產生客戶端
task codegen-api-client
```

#### 3. 實作業務邏輯

```csharp
// Handler
public async Task<Result<LoginResponse>> LoginAsync(
    LoginRequest request, 
    CancellationToken ct)
{
    // 驗證帳號密碼
    var member = await _repository.GetByEmailAsync(request.Email, ct);
    if (member == null || !VerifyPassword(request.Password, member.PasswordHash))
        return Result.Failure<LoginResponse>("帳號或密碼錯誤", "INVALID_CREDENTIALS");
    
    // 產生 JWT Token
    var token = _tokenService.GenerateToken(member);
    
    return Result.Success(new LoginResponse
    {
        Token = token,
        ExpiresAt = DateTime.UtcNow.AddHours(24)
    });
}

// Controller 實作
public override async Task<IActionResult> LoginMember(
    LoginRequest request,
    CancellationToken cancellationToken)
{
    var result = await _handler.LoginAsync(request, cancellationToken);
    
    return result.IsSuccess
        ? Ok(result.Value)
        : Unauthorized(new ErrorResponse { Error = result.Error });
}
```

#### 4. 撰寫 BDD 測試

```gherkin
# Member/MemberLogin.feature

Scenario: 成功登入
  Given 資料庫中已存在會員
    | Email              | Password       |
    | test@example.com   | SecurePass@123 |
  And 我準備登入資料
    | Email              | Password       |
    | test@example.com   | SecurePass@123 |
  When 我發送登入請求至 "/api/members/login"
  Then 回應狀態碼應為 200
  And 回應中應包含 "token"
  And JWT Token 應有效

Scenario: 登入失敗 - 密碼錯誤
  Given 資料庫中已存在會員
    | Email              | Password       |
    | test@example.com   | SecurePass@123 |
  And 我準備登入資料
    | Email              | Password       |
    | test@example.com   | WrongPass@456  |
  When 我發送登入請求至 "/api/members/login"
  Then 回應狀態碼應為 401
  And 錯誤訊息應為 "帳號或密碼錯誤"
```

#### 5. 執行測試

```bash
task test-integration
```

## 版本管理策略

### OpenAPI 規格版本化

```yaml
openapi: 3.0.1
info:
  version: 1.0.0  # API 版本

# URL 版本控制
servers:
  - url: https://api.jobbank.com/v1
  - url: https://api.jobbank.com/v2

# 或使用標頭版本控制
paths:
  /api/members:
    post:
      parameters:
        - name: api-version
          in: header
          schema:
            type: string
            enum: ["1.0", "2.0"]
```

### 破壞性變更處理

```yaml
# ❌ 破壞性變更：移除必填欄位
# Before
CreateMemberRequest:
  required:
    - email
    - name
    - password

# After（破壞性）
CreateMemberRequest:
  required:
    - email
    - name
  # password 變成選填（破壞向後相容性）

# ✅ 非破壞性變更：新增選填欄位
CreateMemberRequest:
  required:
    - email
    - name
    - password
  properties:
    phone:  # 新增選填欄位
      type: string
```

## 文件檢視器設定

### Swagger UI

```csharp
// Program.cs
app.UseSwagger();
app.UseSwaggerUI(options =>
{
    options.SwaggerEndpoint("/swagger/v1/swagger.json", "JobBank API v1");
    options.RoutePrefix = "swagger";
    options.DocExpansion(Swashbuckle.AspNetCore.SwaggerUI.DocExpansion.None);
});
```

### ReDoc

```csharp
app.UseReDoc(options =>
{
    options.SpecUrl = "/swagger/v1/swagger.json";
    options.RoutePrefix = "api-docs";
});
```

### Scalar

```csharp
app.MapScalarApiReference(options =>
{
    options.WithTitle("JobBank API")
           .WithTheme(ScalarTheme.Purple)
           .WithDefaultHttpClient(ScalarTarget.CSharp, ScalarClient.HttpClient);
});
```

## 常見問題

### Q1: 如何處理自動產生的程式碼與自訂邏輯的衝突？

**回答**：使用 **Partial Class** 或 **繼承** 模式：

```csharp
// AutoGenerated/Controllers.g.cs (自動產生)
public abstract class MembersControllerBase : ControllerBase { }

// Member/MemberController.cs (手動實作)
public sealed class MemberController : MembersControllerBase { }
```

### Q2: OpenAPI 規格變更後，如何避免破壞現有測試？

**回答**：
1. 採用 **API 版本控制**（URL 或標頭）
2. 使用 **Contract Testing**（例如：Pact）驗證向後相容性
3. 在 CI/CD 中執行 **Breaking Change Detection**

### Q3: 如何驗證 OpenAPI 規格的正確性？

```bash
# 使用 Spectral 驗證規格
npm install -g @stoplight/spectral-cli
spectral lint doc/openapi.yml

# 使用 OpenAPI Generator 驗證
openapi-generator-cli validate -i doc/openapi.yml
```

## 最佳實踐

- ✅ **先定義 API 規格，再實作程式碼**（API First）
- ✅ **使用語意化版本號**（Major.Minor.Patch）
- ✅ **將自動產生的程式碼放在 `AutoGenerated/` 資料夾**
- ✅ **使用 Git Ignore 排除** `.g.cs` 檔案（或檢查入版本控制後標記為自動產生）
- ✅ **在 CI/CD 中自動產生程式碼**，確保規格與程式碼同步
- ❌ **不要手動編輯** `AutoGenerated/` 資料夾內的檔案

## 參考資料

- [OpenAPI Specification](https://swagger.io/specification/)
- [NSwag Documentation](https://github.com/RicoSuter/NSwag)
- [Refitter](https://github.com/christianhelle/refitter)
- [Refit](https://github.com/reactiveui/refit)
