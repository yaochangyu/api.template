# BDD 開發流程 (行為驅動開發)

專案採用 BDD 開發模式，使用 Docker 容器作為測試替身，確保需求、測試與實作的一致性。

## BDD 開發循環

#### 1. 需求分析階段
使用 Gherkin 語法定義功能情境。

#### 2. 測試實作階段
使用 Reqnroll 與真實 Docker 服務實作測試步驟。

#### 3. Docker 測試環境
完全基於 Docker 的測試環境，避免使用 Mock。包含：
- SQL Server 容器
- Redis 容器
- Seq 日誌容器

## Docker 優先測試策略

#### 核心原則
- **真實環境**: 使用 Docker 容器提供真實的資料庫、快取、訊息佇列等服務
- **避免 Mock**: 只有在無法使用 Docker 替身的外部服務才考慮 Mock
- **隔離測試**: 每個測試使用獨立的資料，測試完成後自動清理
- **並行執行**: 利用 Docker 容器的隔離特性支援測試並行執行

## API 控制器測試指引

#### 核心原則
- **BDD 優先**: 所有控制器功能必須優先使用 BDD 情境測試
- **禁止單獨測試控制器**: 不應直接實例化控制器進行單元測試
- **強制使用 WebApplicationFactory**: 所有測試必須透過完整的 Web API 管線與 Docker 測試環境
- **情境驅動開發**: 從使用者行為情境出發

## 測試策略詢問
當實作新功能或修改現有功能時，**必須詢問**使用者：

**a) 是否需要實作測試？**
- ✅ 是，需要實作完整測試（BDD 整合測試 + 單元測試）
- ✅ 是，僅需要 BDD 整合測試
- ✅ 是，僅需要單元測試
- ❌ 否，暫不實作測試（例如：快速原型、POC 驗證）

**b) 如果需要測試，測試範圍為何？**
- 新增功能的完整測試
- 僅測試核心業務邏輯
- 僅測試關鍵路徑（Happy Path）
- 包含異常情境與邊界條件

**c) BDD 測試情境**（如果選擇 BDD 測試）
- 是否已有 `.feature` 檔案？
- 需要新增哪些情境（Given-When-Then）？
- 是否需要 AI 協助撰寫 Gherkin 語法？

**d) 測試資料準備策略**
- 使用 Docker 容器（資料庫、Redis）
- 使用固定測試資料（Seed Data）
- 每次測試動態產生資料
- 測試後是否需要清理資料？

**e) 測試方法選擇**
- ✅ **API 端點測試必須使用 BDD 測試方法**（透過 Reqnroll 實作 .feature 檔案）
- ✅ **測試替身優先順序**：
  1. 優先使用 Testcontainers（Docker 容器）作為資料庫、Redis 的測試替身
  2. 僅在無法使用 Testcontainers 時才考慮使用 Mock（例如：第三方 API、外部服務）
- ✅ **禁止對 Controller 進行單元測試**：所有 API 測試必須透過完整的 Web API 管線執行
