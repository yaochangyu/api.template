# 專案最佳實踐

本文件匯總了專案的各項最佳實踐，包括程式碼組織、依賴注入、非同步程式設計等。

## 1. 程式碼組織與命名規範

#### 命名規範
- **Handler**: `{Feature}Handler.cs`
- **Repository**: `{Feature}Repository.cs`
- **Controller**: `{Feature}Controller.cs` 或 `{Feature}ControllerImpl.cs`
- **Request/Response DTO**: `{Action}{Feature}Request.cs` / `{Feature}Response.cs`

## 2. 依賴注入最佳實踐

#### 主建構函式注入 (Primary Constructor)
使用 C# 12 的主建構函式簡化依賴注入，直接使用參數名稱，無需宣告欄位。

#### DbContextFactory 模式
使用 `IDbContextFactory<T>` 而非直接注入 `DbContext`，避免生命週期問題。

## 3. 非同步程式設計最佳實踐

#### 核心原則
- 所有 I/O 操作都必須使用 async/await
- 所有非同步方法都應支援 CancellationToken
- 避免使用 `.Result` 或 `.Wait()`（死鎖風險）

## 4. EF Core 查詢最佳化
- 使用 `AsNoTracking()` 提升唯讀查詢效能
- 使用 `Include` 或 `Join` 避免 N+1 查詢問題
- 適當使用分頁查詢

## 5. 程式碼產生與維護

**核心原則**: 所有自動產生的程式碼都放在 `AutoGenerated` 資料夾中，不可手動編輯。

## 6. 常見錯誤與陷阱

#### ❌ 禁止的模式
1. **直接測試 Controller** - 必須透過 BDD 情境測試
2. **不使用 Result Pattern** - 不要拋出業務邏輯例外
3. **未保存原始例外** - 必須將例外寫入 `Failure.Exception`
4. **忘記傳遞 CancellationToken** - 所有非同步方法都應支援
5. **過度設計 Repository** - 從簡單開始，需要時再重構為需求導向
6. **Repository 中實作業務規則** - 複雜業務邏輯應在 Handler 層處理
